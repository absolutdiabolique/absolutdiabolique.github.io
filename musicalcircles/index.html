<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CircleSynth</title>
<link rel="stylesheet" href="../style.css">
</head>
<body>
<canvas id="c"></canvas>

<div id="ui">
  <h2>CircleSynth</h2>

  <label>Config (JSON)</label>
  <textarea id="json" rows="10">
{
  "circles":[
    { "radius":160, "speed": 0.6 },
    { "radius": 90,  "speed": 1.8 },
    { "radius": 40,  "speed":-3.4 },
    { "radius": 25,  "speed": 4.8 }
  ]
}
  </textarea>

  <button id="apply">Apply</button>
</div>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
let W = canvas.width = innerWidth - 300;
let H = canvas.height = innerHeight;
addEventListener("resize", () => {
  W = canvas.width = innerWidth - 300;
  H = canvas.height = innerHeight;
});

let circles = [];
let t = 0;
let trail = [];

// -------------------------------
// Audio synthesis (simple sine)
// -------------------------------
const audio = new (window.AudioContext||window.webkitAudioContext)();
let osc = audio.createOscillator();
let gain = audio.createGain();
osc.type = "sine";
osc.frequency.value = 220;
gain.gain.value = 0.04;
osc.connect(gain).connect(audio.destination);
osc.start();

// distance â†’ pitch conversion
function setPitch(dist){
  const f = 80 + dist*0.9;
  osc.frequency.setTargetAtTime(f, audio.currentTime, 0.05);
}

// --------------------------------
// Load config
// --------------------------------
function loadConfig(){
  try {
    const cfg = JSON.parse(document.getElementById("json").value);
    circles = cfg.circles || [];
  } catch(err){
    alert("JSON parse error: " + err.message);
  }
}
document.getElementById("apply").onclick = loadConfig;
loadConfig();

// --------------------------------
// Core animation
// --------------------------------
let prevTime = performance.now();
const trail = [];

function render(now) {
    requestAnimationFrame(render);
    const dt = (now - prevTime) * 0.001;
    prevTime = now;

    ctx.clearRect(0, 0, W, H);

    // center
    const cx = W / 2;
    const cy = H / 2;

    let x = cx;
    let y = cy;

    // --- draw spinning circles and chained arms ---
    for (const c of circles) {

        // initialize angle once
        if (c.angle === undefined) c.angle = 0;

        // independent rotation per circle
        c.angle += c.speed * dt;

        // next position
        const nx = x + Math.cos(c.angle) * c.radius;
        const ny = y + Math.sin(c.angle) * c.radius;

        // circle outline
        ctx.strokeStyle = "rgba(200,200,200,0.14)";
        ctx.beginPath();
        ctx.arc(x, y, c.radius, 0, Math.PI * 2);
        ctx.stroke();

        // arm to next point
        ctx.strokeStyle = "rgba(255,100,100,0.7)";
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(nx, ny);
        ctx.stroke();

        x = nx;
        y = ny;
    }

    // final endpoint coordinates
    const ex = x;
    const ey = y;

    // --- endpoint marker ---
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.beginPath();
    ctx.arc(ex, ey, 3.5, 0, Math.PI * 2);
    ctx.fill();

    // --- trail ---
    trail.push({ x: ex, y: ey });
    if (trail.length > 1020) trail.shift();

    ctx.strokeStyle = "rgba(255,255,255,0.5)";
    ctx.lineWidth = 1.2;
    ctx.beginPath();

    for (let i = 0; i < trail.length - 1; i++) {
        const p = trail[i];
        const q = trail[i + 1];
        const t = i / trail.length;
        ctx.globalAlpha = t * 0.6;
        ctx.moveTo(p.x, p.y);
        ctx.lineTo(q.x, q.y);
    }

    ctx.stroke();
    ctx.globalAlpha = 1;

    // --- audio: map endpoint to frequency ---
    const dx = ex - cx;
    const dy = ey - cy;
    const dist = Math.sqrt(dx * dx + dy * dy);
    const freq = 220 + dist * 0.6;

    if (audioCtx && audioCtx.state === "running") {
        const osc = window.globalOsc;
        if (osc) {
            osc.frequency.value = freq;
        }
    }
}

render(performance.now());
</script>
</body>
</html>
