<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BounceSim</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
<div id="app">
  <canvas id="c"></canvas>

  <div id="ui">
    <h1>BounceSim</h1>

    <label>Simulation parameters</label>
    <div class="row">
      <div>
        <label>Gravity</label>
        <input id="G" type="number" step="0.01" value="600">
      </div>
      <div>
        <label>Time step (dt)</label>
        <input id="dt" type="number" step="0.001" value="0.016">
      </div>
    </div>

    <label>Dust Parameters</label>
    <div class="row">
      <div>
        <label>Density</label>
        <input id="density" type="number" step="0.01" value="0.4">
      </div>
      <div>
        <label>Particle radius</label>
        <input id="prad" type="number" step="0.5" value="2">
      </div>
    </div>

    <label>Starting configuration (JSON)</label>
    <textarea id="json" rows="16">
{
  "objects": [
    { "type":"line", "x1":-200, "y1":100, "x2":200, "y2":100, "elasticity":0.7 },
    { "type":"ellipse", "x":0, "y":250, "rx":120, "ry":60, "elasticity":0.4 },
    { "type":"discCloud", "x":0, "y":-200, "radius":140, "innerRadius":30, "elasticity":0.2 }
  ]
}
    </textarea>

    <div style="margin-top:8px" class="row">
      <button id="apply">Apply JSON</button>
      <button id="reset">Reset View</button>
    </div>

    <label>Quick actions</label>
    <div class="row">
      <button id="pause">Pause</button>
      <button id="step">Step</button>
    </div>

    <label>Info</label>
    <div id="info" style="font-family:monospace;font-size:13px;line-height:1.3"></div>
  </div>
</div>

<script>
// ------------------------------------------------------------
// Canvas setup
// ------------------------------------------------------------
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d', {alpha:false});
let W = canvas.width = innerWidth - 340;
let H = canvas.height = innerHeight;
window.addEventListener('resize', ()=>{
  W = canvas.width = innerWidth - 340;
  H = canvas.height = innerHeight;
});

// ------------------------------------------------------------
// UI elements
// ------------------------------------------------------------
const Ginp = document.getElementById('G');
const dtInp = document.getElementById('dt');
const densityInp = document.getElementById('density');
const pradInp = document.getElementById('prad');
const jsonArea = document.getElementById('json');
const applyBtn = document.getElementById('apply');
const resetBtn = document.getElementById('reset');
const pauseBtn = document.getElementById('pause');
const stepBtn = document.getElementById('step');
const infoDiv = document.getElementById('info');

let paused=false, stepOnce=false;

// ------------------------------------------------------------
// Object classes
// ------------------------------------------------------------
class LineObj{constructor(x1,y1,x2,y2,e){this.x1=x1;this.y1=y1;this.x2=x2;this.y2=y2;this.e=e;}}
class EllipseObj{constructor(x,y,rx,ry,e){this.x=x;this.y=y;this.rx=rx;this.ry=ry;this.e=e;}}
class DiscCloud{constructor(x,y,r,inner,e){this.x=x;this.y=y;this.r=r;this.inner=inner;this.e=e;}}
class RectCloud{constructor(x,y,w,h,e){this.x=x;this.y=y;this.w=w;this.h=h;this.e=e;}}

let lines=[], ellipses=[], particles=[], rects=[], discs=[];

// ------------------------------------------------------------
// Utility
// ------------------------------------------------------------
function seedFromConfig(cfg){
  lines=[]; ellipses=[]; particles=[]; rects=[]; discs=[];

  const objs = cfg.objects || [];
  for(const o of objs){
    if(o.type==="line")
      lines.push(new LineObj(+o.x1,+o.y1,+o.x2,+o.y2,+o.elasticity||0.3));
    if(o.type==="ellipse")
      ellipses.push(new EllipseObj(+o.x,+o.y,+o.rx,+o.ry,+o.elasticity||0.3));
    if(o.type==="discCloud")
      discs.push(new DiscCloud(+o.x,+o.y,+o.radius,+o.innerRadius||0,+o.elasticity||0.3));
    if(o.type==="rectCloud")
      rects.push(new RectCloud(+o.x,+o.y,+o.w,+o.h,+o.elasticity||0.3));
  }

  const density = Math.max(0, parseFloat(densityInp.value) || 0.2);
  const GOLDEN = 2.39996323;

  for(const d of discs){
    const area = Math.PI*(d.r*d.r - d.inner*d.inner);
    const n = Math.max(1, Math.floor(area * density));
    for(let k=0;k<n;k++){
      const f = (k+0.5)/n;
      const r = Math.sqrt(f)*(d.r - d.inner) + d.inner;
      const th = k*GOLDEN;
      particles.push({
        x:d.x + Math.cos(th)*r,
        y:d.y + Math.sin(th)*r,
        vx:0,vy:0, ax:0,ay:0,
        elasticity:d.e
      });
    }
  }

  for(const r of rects){
    const area = r.w*r.h;
    const n = Math.max(1, Math.floor(area*density));
    const cols = Math.ceil(Math.sqrt(n));
    const rows = Math.ceil(n/cols);

    const cellW = r.w/cols;
    const cellH = r.h/rows;
    for(let k=0;k<n;k++){
      const c = k%cols, row = Math.floor(k/cols);
      particles.push({
        x:r.x + (-r.w/2 + (c+0.5)*cellW),
        y:r.y + (-r.h/2 + (row+0.5)*cellH),
        vx:0,vy:0, ax:0,ay:0,
        elasticity:r.e
      });
    }
  }

  infoDiv.textContent = "Seeded: "+particles.length+" particles";
}

// ------------------------------------------------------------
// Collision helpers
// ------------------------------------------------------------
function bounceParticle(p, nx, ny, elasticity){
  const vdot = p.vx*nx + p.vy*ny;
  if(vdot < 0){
    p.vx -= (1+elasticity)*vdot*nx;
    p.vy -= (1+elasticity)*vdot*ny;
  }
}

// ------------------------------------------------------------
// Step physics
// ------------------------------------------------------------
function stepPhysics(dt){
  const G = parseFloat(Ginp.value) || 600;
  const prad = parseFloat(pradInp.value)||2;

  for(const p of particles){
    p.ay = G;
    p.vx += p.ax*dt;
    p.vy += p.ay*dt;
    p.x  += p.vx*dt;
    p.y  += p.vy*dt;

    // ------ line collisions ------
    for(const L of lines){
      const vx = L.x2-L.x1, vy=L.y2-L.y1;
      const wx = p.x-L.x1, wy=p.y-L.y1;
      const segLen2=vx*vx+vy*vy;
      const t = Math.max(0,Math.min(1,(wx*vx+wy*vy)/segLen2));
      const cx=L.x1+t*vx, cy=L.y1+t*vy;

      const dx=p.x-cx, dy=p.y-cy;
      const dist=Math.sqrt(dx*dx+dy*dy);
      if(dist < prad){
        const nx=dx/dist, ny=dy/dist;
        p.x = cx + nx*prad;
        p.y = cy + ny*prad;
        bounceParticle(p,nx,ny,p.elasticity*L.e);
      }
    }

    // ------ ellipse collisions ------
    for(const E of ellipses){
      const rx=E.rx, ry=E.ry;
      const dx=p.x-E.x, dy=p.y-E.y;
      const k = (dx*dx)/(rx*rx) + (dy*dy)/(ry*ry);
      if(k < 1){
        const nx = dx/(rx*rx);
        const ny = dy/(ry*ry);
        const nlen = Math.hypot(nx,ny);
        const ux=nx/nlen, uy=ny/nlen;
        p.x = E.x + dx/Math.sqrt(k);
        p.y = E.y + dy/Math.sqrt(k);
        bounceParticle(p,ux,uy,p.elasticity*E.e);
      }
    }
  }
}

// ------------------------------------------------------------
// Rendering
// ------------------------------------------------------------
let last=performance.now();
let view={x:0,y:0,scale:1};

function render(now){
  const dt = parseFloat(dtInp.value)||0.016;

  if(!paused || stepOnce){
    stepPhysics(dt);
    if(stepOnce){ stepOnce=false; paused=true; }
  }

  ctx.fillStyle="#000";
  ctx.fillRect(0,0,W,H);

  const s = W/(1000*view.scale);

  const prad = parseFloat(pradInp.value)||2;
  ctx.fillStyle="white";
  for(const p of particles){
    const px=(p.x-view.x)*s + W/2;
    const py=(p.y-view.y)*s + H/2;
    ctx.fillRect(px|0, py|0, prad, prad);
  }

  for(const L of lines){
    ctx.strokeStyle="rgba(255,255,255,0.3)";
    ctx.beginPath();
    ctx.moveTo((L.x1-view.x)*s+W/2, (L.y1-view.y)*s+H/2);
    ctx.lineTo((L.x2-view.x)*s+W/2, (L.y2-view.y)*s+H/2);
    ctx.stroke();
  }

  for(const E of ellipses){
    ctx.strokeStyle="rgba(255,255,255,0.2)";
    ctx.beginPath();
    ctx.ellipse(
      (E.x-view.x)*s+W/2,
      (E.y-view.y)*s+H/2,
      E.rx*s,E.ry*s,
      0,0,Math.PI*2
    );
    ctx.stroke();
  }

  infoDiv.textContent = `particles: ${particles.length}`;

  requestAnimationFrame(render);
}

// ------------------------------------------------------------
// Handlers
// ------------------------------------------------------------
applyBtn.addEventListener('click',()=>{
  try{ seedFromConfig(JSON.parse(jsonArea.value)); }
  catch(e){ alert(e); }
});
resetBtn.addEventListener('click',()=>{ view={x:0,y:0,scale:1}; });
pauseBtn.addEventListener('click',()=>{ paused=!paused; pauseBtn.textContent = paused?"Resume":"Pause"; });
stepBtn.addEventListener('click',()=>{ stepOnce=true; paused=false; });

// pan + zoom
let dragging=false, lastMouse=null;
canvas.addEventListener('mousedown',e=>{
  dragging=true; lastMouse=[e.clientX,e.clientY];
});
window.addEventListener('mouseup',()=>{ dragging=false; lastMouse=null; });
window.addEventListener('mousemove',e=>{
  if(!dragging) return;
  const dx=e.clientX-lastMouse[0];
  const dy=e.clientY-lastMouse[1];
  view.x -= dx; view.y -= dy;
  lastMouse=[e.clientX,e.clientY];
});
canvas.addEventListener('wheel',e=>{
  e.preventDefault();
  const sc=Math.exp(-e.deltaY*0.001);
  view.scale*=sc;
});

// Initial
try{ seedFromConfig(JSON.parse(jsonArea.value)); }catch(e){ }
requestAnimationFrame(render);
</script>
</body>
</html>
